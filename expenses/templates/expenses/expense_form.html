{% extends 'expenses/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1><i class="fas fa-plus-circle"></i> {{ title }}</h1>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="message error">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            {% if edit_restrictions and not edit_restrictions.can_edit_amount %}
                <div class="message warning">
                    <i class="fas fa-exclamation-triangle"></i> Note: Amount cannot be edited because this expense has paid items. You can still update other fields.
                </div>
            {% endif %}

            {% if edit_restrictions and not edit_restrictions.can_edit_date %}
                <div class="message warning">
                    <i class="fas fa-exclamation-triangle"></i> Note: Date cannot be edited for expenses earlier than next month. You can still update other fields.
                </div>
            {% endif %}

            <!-- Two column layout for main fields -->
            <div class="grid-2-cols">
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}">{{ form.title.label }}:</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="message error">{{ form.title.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.total_amount.id_for_label }}" id="total-amount-label">{{ form.total_amount.label }}:</label>
                    {{ form.total_amount }}
                    <small id="total-amount-help"></small>
                    {% if edit_restrictions and not edit_restrictions.can_edit_amount %}
                        <small class="text-muted"><i class="fas fa-lock"></i> {{ form.total_amount.help_text }}</small>
                    {% endif %}
                    {% if form.total_amount.errors %}
                        <div class="message error">{{ form.total_amount.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.payee.id_for_label }}">{{ form.payee.label }}:</label>
                    {{ form.payee }}
                    {% if form.payee.errors %}
                        <div class="message error">{{ form.payee.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.expense_type.id_for_label }}">{{ form.expense_type.label }}:</label>
                    {{ form.expense_type }}
                    {% if form.expense_type.errors %}
                        <div class="message error">{{ form.expense_type.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group" id="installments-group">
                    <label for="{{ form.installments_count.id_for_label }}">{{ form.installments_count.label }}:</label>
                    {{ form.installments_count }}
                    {% if form.installments_count.errors %}
                        <div class="message error">{{ form.installments_count.errors }}</div>
                    {% endif %}
                    <small>Only required for split payment expenses</small>
                </div>

                <div class="form-group" id="initial-installment-group">
                    <label for="{{ form.initial_installment.id_for_label }}">{{ form.initial_installment.label }}:</label>
                    {{ form.initial_installment }}
                    {% if form.initial_installment.errors %}
                        <div class="message error">{{ form.initial_installment.errors }}</div>
                    {% endif %}
                    <small>Starting installment number (0 = start from first installment). Only used for split payments.</small>
                    {% if form.initial_installment.help_text %}
                        <small class="text-muted"><i class="fas fa-lock"></i> {{ form.initial_installment.help_text }}</small>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.started_at.id_for_label }}">{{ form.started_at.label }}:</label>
                    {{ form.started_at }}
                    <small>Start date cannot be earlier than the currently active month. If you set it to the current month, expense items will be created immediately.</small>
                    {% if edit_restrictions and not edit_restrictions.can_edit_date %}
                        <small class="text-muted"><i class="fas fa-lock"></i> {{ form.started_at.help_text }}</small>
                    {% endif %}
                    {% if form.started_at.help_text and edit_restrictions.can_edit_date %}
                        <small>{{ form.started_at.help_text }}</small>
                    {% endif %}
                    {% if form.started_at.errors %}
                        <div class="message error">{{ form.started_at.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group" id="end-date-group">
                <label for="{{ form.end_date.id_for_label }}">{{ form.end_date.label }}:</label>
                {{ form.end_date }}
                <small>End date must be on or after the start date. The final payment will be generated in the month containing this date.</small>
                <div id="payment-count-preview" style="display: none; margin-top: 8px;">
                    <small><strong>Payment Preview:</strong> <span id="payment-count-text"></span></small>
                </div>
                {% if form.end_date.help_text %}
                    <small>{{ form.end_date.help_text }}</small>
                {% endif %}
                {% if form.end_date.errors %}
                    <div class="message error">{{ form.end_date.errors }}</div>
                {% endif %}
            </div>

            <!-- Notes field below in full width -->
            <div class="form-group">
                <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}:</label>
                {{ form.notes }}
                {% if form.notes.help_text %}
                    <small>{{ form.notes.help_text }}</small>
                {% endif %}
                {% if form.notes.errors %}
                    <div class="message error">{{ form.notes.errors }}</div>
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn"><i class="fas fa-floppy-disk icon-left"></i>Save Expense</button>
                <a href="{% url 'expense_list' budget.id %}" class="btn btn-secondary"><i class="fas fa-xmark icon-left"></i>Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const expenseTypeSelect = document.getElementById('expense-type-select');
    const installmentsGroup = document.getElementById('installments-group');
    const installmentsInput = document.querySelector('#installments-group input');
    const initialInstallmentGroup = document.getElementById('initial-installment-group');
    const initialInstallmentInput = document.querySelector('#initial-installment-group input');
    const endDateGroup = document.getElementById('end-date-group');
    const endDateInput = document.querySelector('#end-date-group input');
    const totalAmountLabel = document.getElementById('total-amount-label');
    const totalAmountHelp = document.getElementById('total-amount-help');
    const totalAmountInput = document.querySelector('input[name="total_amount"]');

    function toggleFields() {
        // Handle installments field
        if (expenseTypeSelect.value === 'split_payment') {
            installmentsGroup.style.display = 'block';
            installmentsInput.required = true;
            initialInstallmentGroup.style.display = 'block';
        } else {
            installmentsGroup.style.display = 'none';
            installmentsInput.required = false;
            installmentsInput.value = '0';
            initialInstallmentGroup.style.display = 'none';
            initialInstallmentInput.value = '0';
        }
        
        // Handle end date field
        if (expenseTypeSelect.value === 'recurring_with_end') {
            endDateGroup.style.display = 'block';
            endDateInput.required = true;
        } else {
            endDateGroup.style.display = 'none';
            endDateInput.required = false;
            endDateInput.value = '';
        }
        
        // Handle total amount field label and help text
        if (expenseTypeSelect.value === 'split_payment') {
            totalAmountLabel.textContent = totalAmountInput.dataset.splitLabel + ':';
            totalAmountHelp.textContent = totalAmountInput.dataset.splitHelp;
        } else {
            totalAmountLabel.textContent = totalAmountInput.dataset.otherLabel + ':';
            totalAmountHelp.textContent = totalAmountInput.dataset.otherHelp;
        }
    }

    expenseTypeSelect.addEventListener('change', toggleFields);
    toggleFields(); // Initialize on page load
    
    // Payment count preview for recurring_with_end
    function calculatePaymentCount() {
        const startDateInput = document.querySelector('input[name="started_at"]');
        const endDateInput = document.querySelector('input[name="end_date"]');
        const paymentCountPreview = document.getElementById('payment-count-preview');
        const paymentCountText = document.getElementById('payment-count-text');
        
        if (expenseTypeSelect.value === 'recurring_with_end' && startDateInput.value && endDateInput.value) {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (endDate >= startDate) {
                const startYear = startDate.getFullYear();
                const startMonth = startDate.getMonth();
                const endYear = endDate.getFullYear();
                const endMonth = endDate.getMonth();
                
                const totalMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
                
                if (totalMonths > 0) {
                    paymentCountText.textContent = `${totalMonths} payment${totalMonths === 1 ? '' : 's'} will be generated`;
                    paymentCountPreview.style.display = 'block';
                } else {
                    paymentCountPreview.style.display = 'none';
                }
            } else {
                paymentCountPreview.style.display = 'none';
            }
        } else {
            paymentCountPreview.style.display = 'none';
        }
    }
    
    document.querySelector('input[name="started_at"]').addEventListener('change', calculatePaymentCount);
    endDateInput.addEventListener('change', calculatePaymentCount);
    calculatePaymentCount(); // Initialize on page load
    
    // Character counter for notes field
    function setupNotesCounter() {
        const notesField = document.querySelector('textarea[name="notes"]');
        if (notesField) {
            const counter = document.createElement('small');
            counter.className = 'character-counter';
            notesField.parentNode.appendChild(counter);
            
            function updateCounter() {
                const remaining = 1024 - notesField.value.length;
                counter.textContent = `${remaining} characters remaining`;
                counter.className = remaining < 50 ? 'character-counter warning' : 'character-counter';
            }
            
            notesField.addEventListener('input', updateCounter);
            updateCounter();
        }
    }
    
    setupNotesCounter();
});
</script>
{% endblock %}
